# Конфигурация аналитики для анализа процента ошибок запросов YDB
# Отслеживает долю ошибок от общего числа запросов (error_rate)
#
# ЭТОТ КОНФИГ ОБНАРУЖИВАЕТ:
# - Появление новых ошибок (degradation_start) - негативное событие
# - Исчезновение ошибок (improvement_start) - позитивное событие
#
# Особенности:
# - Отслеживает ошибки по их тексту (поле error в контексте)
# - Анализирует процент ошибок (error_rate) вместо абсолютного количества
# - Настраиваемое отслеживание исчезновения: ошибка должна отсутствовать 3 часа подряд

job:
  name: "query_error_rate_analysis"
  description: "Анализ процента ошибок выполнения запросов YDB - обнаружение появления и исчезновения ошибок"

data_source:
  aggregate_by: "1h"  # Автоматическая агрегация по часам в Python (1h = 1 час, можно указать: 15min, 30S, 1D и т.д.)
  compute_error_rate: true  # Вычислять процент ошибок (error_rate) вместо количества
  ydb:
    # Простой запрос - загружаем все записи (успешные и ошибки) без агрегации
    # Агрегация по часам и вычисление error_rate будут выполнены автоматически
    query: |
      SELECT
        timestamp as ts,
        operation_type,
        script_name,
        query_name,
        cluster_version,
        error,
        status,
        1 as metric_value,
        'error_rate' as metric_name
      FROM `analytics/query_statistics`
      WHERE timestamp >= CurrentUtcTimestamp() - 30 * Interval("P1D")
        AND operation_type IN ('scan_query', 'bulk_upsert', 'dml_query')

# Контекстные поля для группировки
# Эти поля определяют, как различаются ошибки:
# - Если значения этих полей совпадают → это одна и та же ошибка
# - Если значения отличаются → это разные ошибки
#
# Текущая настройка: ошибки различаются по:
# - operation_type (тип операции, например "scan_query")
# - script_name (имя скрипта)
# - query_name (имя запроса)
# - cluster_version (версия кластера)
# - error (текст ошибки)
#
# Это означает, что каждая уникальная комбинация этих полей считается отдельной ошибкой.
# Например:
# - "scan_query" + "script1.py" + "query1" + "v1.0" + "Connection timeout" = одна ошибка
# - "scan_query" + "script1.py" + "query1" + "v1.0" + "Invalid syntax" = другая ошибка
context_fields: ["operation_type", "script_name", "query_name", "cluster_version", "error"]

# Поля метрик
metric_fields: ["metric_name", "metric_value"]

# Поле временной метки
timestamp_field: "ts"

analytics:
  baseline_method: "rolling_mean"
  window_size: 7
  sensitivity: 2.0
  min_absolute_change: 1.0              # минимальное изменение 1 процентный пункт
  min_relative_change: 0.3              # 30% изменение
  hysteresis_points: 3
  adaptive_threshold: true

# ----------------------------------------------------------------------------
# ОТСЛЕЖИВАНИЕ ИЗМЕНЕНИЙ КОНТЕКСТОВ
# ----------------------------------------------------------------------------
# Эта секция позволяет отслеживать появление и исчезновение контекстов
# Для ошибок:
# - Новый контекст (новая ошибка) = негативное событие (degradation_start)
# - Исчезнувший контекст (ошибка пропала) = позитивное событие (improvement_start)
context_tracking:
  # Включить отслеживание новых контекстов (появились новые комбинации полей)
  track_new_contexts: true
  
  # Включить отслеживание исчезнувших контекстов (старые комбинации пропали)
  track_disappeared_contexts: true
  
  # Правила для обработки изменений контекстов
  context_change_rules:
    # Метрики, для которых отслеживать появление новых контекстов
    new_context_metrics:
      error_rate:
        # Тип события при появлении нового контекста
        event_type: "degradation_start"  # негативное событие
        
        # Серьезность события
        severity: "high"
        
        # Значение baseline до появления (обычно 0 для новых ошибок)
        baseline_before: 0.0
        
        # Минимальное значение для создания события
        min_value: 0.01  # минимум 1% ошибок
    
    # Метрики, для которых отслеживать исчезновение контекстов
    disappeared_context_metrics:
      error_rate:
        # Тип события при исчезновении контекста
        event_type: "improvement_start"  # позитивное событие
        
        # Серьезность события
        severity: "medium"
        
        # Значение baseline после исчезновения (обычно 0)
        baseline_after: 0.0
        
        # ================================================================
        # НАСТРОЙКИ ДЛЯ ОПРЕДЕЛЕНИЯ "ИСЧЕЗНОВЕНИЯ"
        # ================================================================
        
        # Количество точек данных подряд, когда ошибка должна отсутствовать
        # Например, при aggregate_by: "1h" и min_absence_points: 3
        # ошибка должна отсутствовать 3 часа подряд
        min_absence_points: 3  # 3 точки подряд без ошибки
        
        # Тип проверки отсутствия:
        # - "consecutive" = точки должны быть подряд (рекомендуется)
        #   Пример: при min_absence_points: 3 ошибка должна отсутствовать
        #   в 3 последовательных точках (например, 3 часа подряд)
        # - "total" = всего в окне (менее строго, не рекомендуется)
        #   Пример: при min_absence_points: 3 ошибка должна отсутствовать
        #   в 3 точках из всего окна (не обязательно подряд)
        absence_type: "consecutive"
        
        # Минимальное количество точек ДО окна, чтобы контекст считался "стабильным"
        # Если контекст появился только 1 раз и сразу пропал - это не считается исчезновением
        # По умолчанию: 2 (контекст должен был появиться минимум 2 раза)
        min_historical_points: 2

# Направление метрик (negative = больше хуже, positive = больше лучше)
metric_direction:
  default: "negative"
  error_rate: "negative"

events:
  detect:
    - degradation_start                # увеличение процента ошибок
    - improvement_start                  # уменьшение процента ошибок
  output_table: "analytics/query_error_rate_events"
  min_event_duration_minutes: 60       # минимальная длительность 1 час

thresholds:
  output_table: "analytics/query_error_rate_thresholds"
  keep_history: true

output:
  write_to_ydb: true
  log_to_console: true
  dry_run: false

runtime:
  timezone: "UTC"
  max_runtime_minutes: 25

