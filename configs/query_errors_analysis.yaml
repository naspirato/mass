# Конфигурация аналитики для анализа ошибок запросов YDB
# Отслеживает появление ошибок и их частоту
#
# ЭТОТ КОНФИГ ОБНАРУЖИВАЕТ:
# - Появление новых ошибок (degradation_start) - негативное событие
# - Исчезновение ошибок (improvement_start) - позитивное событие
#
# Особенности:
# - Быстрое реагирование: min_event_duration_minutes: 30 (30 минут)
# - Высокая чувствительность: реагирует на любое увеличение (min_absolute_change: 1)
# - Анализирует абсолютное количество ошибок (агрегация по часам для детального анализа)
# - Настраиваемое отслеживание исчезновения: ошибка должна отсутствовать 3 часа подряд

job:
  name: "query_errors_analysis"
  description: "Анализ ошибок выполнения запросов YDB - обнаружение появления и исчезновения ошибок"

data_source:
  # Агрегация по часам для более детального анализа ошибок
  aggregate_by: "1h"  # Автоматическая агрегация по часам в Python (1h = 1 час, можно указать: 1D, 15min, 30S и т.д.)
  ydb:
    # Простой запрос - загружаем все ошибки без агрегации
    # Агрегация будет выполнена автоматически на основе aggregate_by: "1h"
    query: |
      SELECT
        timestamp as ts,
        operation_type,
        script_name,
        query_name,
        error,  
        1 as metric_value,
        'error_count' as metric_name
      FROM `analytics/query_statistics`
      WHERE timestamp >= CurrentUtcTimestamp() - 30 * Interval("P1D")
        AND status = 'error'
        AND operation_type IN ('scan_query')

# Контекстные поля для группировки
# Эти поля определяют, как различаются ошибки:
# - Если значения этих полей совпадают → это одна и та же ошибка
# - Если значения отличаются → это разные ошибки
#
# Текущая настройка: ошибки различаются по:
# - operation_type (тип операции, например "scan_query")
# - script_name (имя скрипта)
# - query_name (имя запроса)
# - error (текст ошибки)
#
# Это означает, что каждая уникальная комбинация этих полей считается отдельной ошибкой.
# Например:
# - "scan_query" + "script1.py" + "query1" + "Connection timeout" = одна ошибка
# - "scan_query" + "script1.py" + "query1" + "Invalid syntax" = другая ошибка
# - "scan_query" + "script1.py" + "query2" + "Connection timeout" = третья ошибка
context_fields: ["operation_type", "script_name", "query_name", "error"]

# Поля метрик
metric_fields: ["metric_name", "metric_value"]

# Поле временной метки
timestamp_field: "ts"

analytics:
  baseline_method: "rolling_mean"
  window_size: 1                     # окно в точках (24 часа для почасовой агрегации = 1 день)
  sensitivity: 2.5                    # более высокая чувствительность для ошибок
  min_absolute_change: 1               # любое увеличение количества ошибок важно
  min_relative_change: 0.5             # 50% изменение
  hysteresis_points: 2                 # меньше точек гистерезиса для быстрого реагирования
  adaptive_threshold: true
  min_data_points: 2                   # минимальное количество точек для анализа (по умолчанию 3, уменьшено для малого объема данных)

# ----------------------------------------------------------------------------
# ОТСЛЕЖИВАНИЕ ИЗМЕНЕНИЙ КОНТЕКСТОВ
# ----------------------------------------------------------------------------
# Эта секция позволяет отслеживать появление и исчезновение контекстов
# Для ошибок:
# - Новый контекст (новая ошибка) = негативное событие (degradation_start)
# - Исчезнувший контекст (ошибка пропала) = позитивное событие (improvement_start)
context_tracking:
  # Включить отслеживание новых контекстов (появились новые комбинации полей)
  track_new_contexts: true
  
  # Включить отслеживание исчезнувших контекстов (старые комбинации пропали)
  track_disappeared_contexts: true
  
  # Правила для обработки изменений контекстов
  context_change_rules:
    # Метрики, для которых отслеживать появление новых контекстов
    new_context_metrics:
      error_count:
        # Тип события при появлении нового контекста
        event_type: "degradation_start"  # негативное событие
        
        # Серьезность события
        severity: "high"
        
        # Значение baseline до появления (обычно 0 для новых ошибок)
        baseline_before: 0.0
        
        # Минимальное значение для создания события
        min_value: 1
    
    # Метрики, для которых отслеживать исчезновение контекстов
    disappeared_context_metrics:
      error_count:
        # Тип события при исчезновении контекста
        event_type: "improvement_start"  # позитивное событие
        
        # Серьезность события
        severity: "medium"
        
        # Значение baseline после исчезновения (обычно 0)
        baseline_after: 0.0
        
        # ================================================================
        # НАСТРОЙКИ ДЛЯ ОПРЕДЕЛЕНИЯ "ИСЧЕЗНОВЕНИЯ"
        # ================================================================
        
        # Количество точек данных подряд, когда ошибка должна отсутствовать
        # Например, при aggregate_by: "1h" и min_absence_points: 3
        # ошибка должна отсутствовать 3 часа подряд
        min_absence_points: 3  # 3 точки подряд без ошибки
        
        # Тип проверки отсутствия:
        # - "consecutive" = точки должны быть подряд (рекомендуется)
        #   Пример: при min_absence_points: 3 ошибка должна отсутствовать
        #   в 3 последовательных точках (например, 3 часа подряд)
        # - "total" = всего в окне (менее строго, не рекомендуется)
        #   Пример: при min_absence_points: 3 ошибка должна отсутствовать
        #   в 3 точках из всего окна (не обязательно подряд)
        absence_type: "consecutive"
        
        # Минимальное количество точек ДО окна, чтобы контекст считался "стабильным"
        # Если контекст появился только 1 раз и сразу пропал - это не считается исчезновением
        # По умолчанию: 2 (контекст должен был появиться минимум 2 раза)
        min_historical_points: 2

# Направление метрик (negative = больше хуже, positive = больше лучше)
metric_direction:
  default: "negative"
  error_count: "negative"

events:
  detect:
    - degradation_start                # увеличение количества ошибок
    - improvement_start                  # уменьшение количества ошибок
  output_table: "analytics/query_errors_events"
  min_event_duration_minutes: 30      # минимальная длительность 30 минут

thresholds:
  output_table: "analytics/query_errors_thresholds"
  keep_history: true

output:
  write_to_ydb: true
  log_to_console: true
  dry_run: false

runtime:
  timezone: "UTC"
  max_runtime_minutes: 20
